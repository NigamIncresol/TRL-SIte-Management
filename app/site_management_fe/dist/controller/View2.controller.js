sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/Panel","sap/m/HBox","sap/m/VBox","sap/m/Input","sap/m/Label","sap/m/MessageToast","sap/ui/layout/Grid","sap/ui/model/json/JSONModel","sap/ui/core/CustomData","sap/m/MessageBox"],function(e,t,o,s,i,n,a,r,c,d,l){"use strict";let u;return e.extend("com.trl.sitemanagementfe.controller.View2",{onInit:function(){u=this.getOwnerComponent().getModel();const e=this.getOwnerComponent().getRouter();e.getRoute("RouteView2").attachPatternMatched(this._onRouteMatched,this);this.getView().setModel(new c,"view");this._isExistingDailyProduction=false},_onRouteMatched:function(){this._clearPage()},onAfterRendering:function(){this.getISTDate()},getISTDate:function(){const e=new Date;const t=5.5*60*60*1e3;const o=new Date(e.getTime()+t);this.byId("siteDate").setValue(o.toISOString().split("T")[0]);return o.toISOString().split("T")[0]},onSiteIdLiveChange:function(e){const t=e.getSource();t.setValue("");a.show("Please select Site ID using the value help",{duration:2e3})},onProdLineLiveChange:function(e){const t=e.getSource();t.setValue("");a.show("Please select Line name using the value help",{duration:2e3})},onSiteIdValueHelp:function(){const e=this.getView();if(!this._oSiteVHDialog){this._oSiteVHDialog=new sap.m.SelectDialog({title:"Select Site ID",liveChange:e=>{this._onSiteSearch(e)},confirm:e=>{this._onSiteSelect(e)},cancel:()=>{this._oSiteVHDialog.close()},items:{path:"/sites",template:new sap.m.StandardListItem({title:"{site_id}",description:"{customer_name} - {location}"})}});e.addDependent(this._oSiteVHDialog)}const t=u.bindList("/siteMaster");t.requestContexts().then(e=>{const t=e.map(e=>e.getObject());const o=new sap.ui.model.json.JSONModel({sites:t});this._oSiteVHDialog.setModel(o);this._oSiteVHDialog.open()}).catch(e=>{sap.m.MessageToast.show("Failed to load Site IDs");console.error(e)})},_onSiteSearch:function(e){const t=e.getParameter("value");const o=new sap.ui.model.Filter("site_id",sap.ui.model.FilterOperator.Contains,t);e.getSource().getBinding("items").filter([o])},_onSiteSelect:function(e){this.byId("ProductionLineId").setValue("");const t=e.getParameter("selectedItem");if(!t)return;const o=t.getTitle();const s=this.byId("siteId");s.setValue(o);this._oSiteVHDialog.close()},onProdLineValueHelp:function(){let e=this.byId("siteId").getValue();if(!e){sap.m.MessageToast.show("Please select a Site ID !");return}const t=this.getView();if(!this._oProdVHDialog){this._oProdVHDialog=new sap.m.SelectDialog({title:"Select Production Line",liveChange:e=>{this._onProdLineSearch(e)},confirm:e=>{this._onProdLineSelect(e)},cancel:()=>{this._oProdVHDialog.close()},items:{path:"/prods",template:new sap.m.StandardListItem({title:"{line_name}",description:"Site ID : {site_site_id}"})}});t.addDependent(this._oProdVHDialog)}const o=u.bindContext(`/siteMaster(site_id='${e}')`,null,{$expand:{productionLines:true}});o.requestObject().then(e=>{console.log("received production data",e.productionLines);this.siteMasterCompleteData=e;const t=e.productionLines||[];const o=new sap.ui.model.json.JSONModel({prods:t});this._oProdVHDialog.setModel(o);this._oProdVHDialog.open()}).catch(e=>{sap.m.MessageToast.show("Failed to load production lines.");console.error(e)})},_onProdLineSearch:function(e){const t=e.getParameter("value");const o=new sap.ui.model.Filter("line_name",sap.ui.model.FilterOperator.Contains,t);e.getSource().getBinding("items").filter([o])},_onProdLineSelect:function(e){const t=e.getParameter("selectedItem");if(!t)return;const o=t.getTitle();const s=this.byId("ProductionLineId");s.setValue(o);this._oProdVHDialog.close()},onFindPress:async function(){const e=this.getView();let t=e.getModel("view");if(!t){t=new sap.ui.model.json.JSONModel;e.setModel(t,"view")}const o=e.byId("siteId").getValue().trim();const s=e.byId("ProductionLineId").getValue().trim();const i=e.byId("siteDate").getValue().trim();if(!o||!s||!i){sap.m.MessageToast.show("Please fill all required fields");return}const n=this.siteMasterCompleteData;t.setProperty("/siteMaster",{customer_name:n.customer_name,location:n.location,runner_id:n.runner_id});const a=`/dailyProduction(`+`site_id='${o}',`+`productionLineName='${s}',`+`production_date=${i}`+`)`;const r=u.bindContext(a);try{const e=await r.requestObject();this._isExistingDailyProduction=true;const o=!!e.productionStageCompleted;t.setProperty("/isProductionEditable",!o);if(o){sap.m.MessageToast.show("Production stage already submitted. Editing disabled.")}else{sap.m.MessageToast.show("Existing production data found for the selected line/date")}this.renderProductionLine(n,e);this.byId("remark").setValue(e.remarks||"");t.setProperty("/campinfo",{campaign_no:e.curr_campaign||"",repair_status:e.curr_repair_status||"",minor_repair_status:e.curr_minor_repair_status||0})}catch(e){if(e?.status!==404){console.error("OData Error:",e);sap.m.MessageToast.show("Error fetching daily production data");return}sap.m.MessageToast.show("No production data found for the selected line/date");this._isExistingDailyProduction=false;t.setProperty("/isProductionEditable",true);this.renderProductionLine(n,null);const o=n.productionLines.find(e=>e.line_name===s);t.setProperty("/campinfo",o?{campaign_no:o.curr_campaign,repair_status:o.curr_repair_status,minor_repair_status:o.curr_minor_repair_status}:{campaign_no:"",repair_status:"",minor_repair_status:0});this.byId("remark").setValue("")}},renderProductionLine:function(e,t){const o=this.getView();const s=o.getModel("view");const i=o.byId("linesContainer");i.destroyItems();const n=o.byId("ProductionLineId").getValue().trim();const a=(e.productionLines||[]).find(e=>e.line_name===n);if(!a){sap.m.MessageToast.show("Production line not found");return}const r=true;const c=new sap.m.Panel({headerText:"Production Line : "+a.line_name,expandable:false,customData:[new sap.ui.core.CustomData({key:"lineId",value:a.ID})],content:[new sap.ui.layout.Grid({defaultSpan:"L4 M6 S12",hSpacing:1,vSpacing:1,content:[new sap.m.VBox({items:[new sap.m.Label({text:"Production Line Name"}),new sap.m.Input({value:a.line_name,editable:false})]}),new sap.m.VBox({items:[new sap.m.Label({text:"Production Data"}),new sap.m.Input({type:"Number",placeholder:"Enter production data",value:t?.production_data||"",editable:r})]}),new sap.m.VBox({items:[new sap.m.Label({text:"Erosion Data"}),new sap.m.Input({type:"Number",placeholder:"Enter erosion data",value:t?.erosion_data||"",editable:r})]})]})]});c.addStyleClass("sapUiSmallMarginBottom");i.addItem(c)},onSave:function(){const e=this.getView();const t=e.byId("siteId").getValue().trim();const o=e.byId("ProductionLineId").getValue().trim();const s=e.byId("siteDate").getValue().trim();const i=e.byId("remark").getValue();const n=e.getModel("view").getProperty("/campinfo");const a=e.byId("linesContainer").getItems()[0];if(!a){sap.m.MessageToast.show("No production data");return}const r=a.getContent()[0].getContent();const c=parseInt(r[1].getItems()[1].getValue(),10)||0;const d=parseInt(r[2].getItems()[1].getValue(),10)||0;const l={production_data:c,erosion_data:d,remarks:i,curr_campaign:n?.campaign_no||"",curr_repair_status:n?.repair_status||"",curr_minor_repair_status:n?.minor_repair_status||0};if(this._isExistingDailyProduction){const e=`/dailyProduction(`+`site_id='${t}',`+`productionLineName='${o}',`+`production_date=${s}`+`)`;const i=u.bindContext(e);i.requestObject().then(()=>{const e=i.getBoundContext();Object.keys(l).forEach(t=>{e.setProperty(t,l[t])});return u.submitBatch(i.getUpdateGroupId())}).then(()=>{sap.m.MessageToast.show("Production Data updated")}).catch(e=>{const t=e?.message||"Update failed";sap.m.MessageBox.error(t)})}else{const e={site_id:t,productionLineName:o,production_date:s,productionStageCompleted:false,...l};const i=u.bindList("/dailyProduction");const n=i.create(e);n.created().then(()=>{this._isExistingDailyProduction=true;sap.m.MessageToast.show("Production Data created")}).catch(e=>{const t=e?.message||"Create failed";sap.m.MessageBox.error(t)})}},onSubmit:function(){const e=this.getView();const t=e.getModel("view");const o=this.byId("siteId").getValue().trim();const s=this.byId("ProductionLineId").getValue().trim();const i=this.byId("siteDate").getValue().trim();if(!o||!s||!i){sap.m.MessageToast.show("Please fill all required fields");return}sap.m.MessageBox.confirm("Confirm submission? Changes will not be allowed after this.",{title:"Confirm Submission",actions:[sap.m.MessageBox.Action.YES,sap.m.MessageBox.Action.NO],emphasizedAction:sap.m.MessageBox.Action.YES,onClose:function(e){if(e!==sap.m.MessageBox.Action.YES){return}const n=this.getOwnerComponent().getModel();const a=`/dailyProduction(`+`site_id='${o}',`+`productionLineName='${s}',`+`production_date=${i}`+`)`;const r=n.bindContext(a);r.requestObject().then(()=>{const e=r.getBoundContext();e.setProperty("productionStageCompleted",true);return n.submitBatch(r.getUpdateGroupId())}).then(()=>{sap.m.MessageToast.show("Production submitted successfully");t.setProperty("/isProductionEditable",false)}).catch(e=>{let t="Submission failed";if(e?.message){t=e.message}sap.m.MessageBox.error(t);console.error(e)})}.bind(this)})},_clearPage:function(){const e=this.getView().getModel("view");e.setData(this._getEmptyViewData());this.byId("siteId").setValue("");this.byId("ProductionLineId").setValue("");this.byId("siteDate").setValue(null);this.byId("remark").setValue("");this.byId("linesContainer").removeAllItems()},_getEmptyViewData:function(){return{siteMaster:{customer_name:"",location:"",runner_id:""},campinfo:{campaign_no:"",repair_status:"",minor_repair_status:""},isProductionEditable:false}},onNavToHome:function(){const e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Home")}})});
//# sourceMappingURL=View2.controller.js.map