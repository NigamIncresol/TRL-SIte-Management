sap.ui.define(["sap/ui/core/mvc/Controller","sap/ui/model/json/JSONModel","sap/m/MessageToast","sap/m/MessageBox"],function(e,t,n,s){"use strict";return e.extend("com.trl.sitemanagementfe.controller.View1",{onInit:function(){this._initModel();this._loadDropdowns();this._setFieldsEditable(false);const e=this.getOwnerComponent().getRouter();e.getRoute("RouteView1").attachPatternMatched(this._onRouteMatched,this)},_onRouteMatched:function(){this._clearPage()},onAfterRendering:async function(){const e=this.getOwnerComponent().getModel();console.log("DEFAULT MODEL =>",e);console.log("MODEL CLASS =>",e?.getMetadata()?.getName())},onModeChange:function(e){const t=e.getParameter("selectedItem").getKey();const n=this.getView();this._clearForm();if(t==="create"){this._initModel();this.byId("linesContainer").destroyItems();this.byId("topName").setEditable(false);this.byId("customer").setEditable(true);this.byId("location").setEditable(true);this.byId("runnerId").setEditable(true);this.byId("lineCount").setEditable(true);this.byId("btnSave").setEnabled(true)}else if(t==="maintain"){const e=this.byId("topName");e.setEditable(true);e.setValue("");this.byId("btnSave").setEnabled(true);this._setFormReadOnly();this.byId("linesContainer").destroyItems();e.detachChange(this.onSiteIdChange);e.attachChange(this.onSiteIdChange.bind(this))}},_setFieldsEditable:function(e){const t=["topName","customer","location","runnerId","campaign","repairStatus","minorRepairStatus","lineCount"];t.forEach(t=>{const n=this.byId(t);if(n){n.setEditable(e)}});this.byId("btnSave").setEnabled(e);this.byId("linesContainer").getItems().forEach(t=>{t.setEditable(e)})},_setFormReadOnly:function(){const e=this.getView();this.byId("customer").setEditable(false);this.byId("location").setEditable(false);this.byId("runnerId").setEditable(false);this.byId("lineCount").setEditable(false);this.byId("topName").setEditable(true)},_setLinesReadOnly:function(){const e=this.byId("linesContainer");e.getItems().forEach(e=>{e.getContent().forEach(e=>{if(e.getItems){e.getItems().forEach(e=>{if(e.setEditable)e.setEditable(false);if(e.getItems){e.getItems().forEach(e=>{if(e.setEditable)e.setEditable(false)})}})}})})},_clearForm:function(){const e=this.getView();const t=e.getModel();this._initModel();this.byId("linesContainer").destroyItems();const n=this.byId("modeDropdown")?.getSelectedKey();if(n==="create"){this.byId("topName").setEditable(false);this.byId("customer").setEditable(true);this.byId("location").setEditable(true);this.byId("runnerId").setEditable(true);this.byId("lineCount").setEditable(true);this.byId("repairStatus").setEditable(true);this.byId("minorRepairStatus").setEditable(true)}else if(n==="maintain"){this.byId("topName").setEditable(true);this.byId("customer").setEditable(false);this.byId("location").setEditable(false);this.byId("runnerId").setEditable(false);this.byId("lineCount").setEditable(false);this.byId("repairStatus").setEditable(true);this.byId("minorRepairStatus").setEditable(true)}},_initModel:function(){const e={site_id:"",customer:"",location:"",runnerId:"",lineCount:0,lines:[]};this.getView().setModel(new t(e))},_loadDropdowns:function(){const e=this.getOwnerComponent().getModel();const t=e.bindList("/customerMaster");t.requestContexts().then(e=>{const t=e.map(e=>e.getObject());const n=new sap.ui.model.json.JSONModel({items:t});this.byId("customer").setModel(n,"customerModel");this.byId("customer").bindItems({path:"customerModel>/items",template:new sap.ui.core.Item({key:"{customerModel>customer_name}",text:"{customerModel>customer_name}"})})});const n=e.bindList("/locationMaster");n.requestContexts().then(e=>{const t=e.map(e=>e.getObject());const n=new sap.ui.model.json.JSONModel({items:t});this.byId("location").setModel(n,"locationModel");this.byId("location").bindItems({path:"locationModel>/items",template:new sap.ui.core.Item({key:"{locationModel>location_name}",text:"{locationModel>location_name}"})})})},onSiteIdChange:function(e){const t=e.getSource().getValue().trim();if(!t)return;this._previousMinorRepairStatus=null;this._oldStatus=null;const n=this.getOwnerComponent().getModel();const s=n.bindContext(`/siteMaster('${t}')`,null,{$expand:{productionLines:{$expand:{sensors:true}}}});s.requestObject().then(e=>{if(e){console.log("received data response",e);this.ExistingcampaignArray=(e.productionLines||[]).map(e=>({line_name:e.line_name,curr_campaign:e.curr_campaign,curr_repair_status:e.curr_repair_status,curr_minor_repair_status:e.curr_minor_repair_status}));const t=this.getView().getModel();t.setProperty("/site_id",e.site_id);t.setProperty("/customer",e.customer_name);t.setProperty("/location",e.location);t.setProperty("/runnerId",e.runner_id);t.setProperty("/lineCount",e.productionLines.length);this._renderProductionLines(e.productionLines,true)}else{sap.m.MessageToast.show("Site not found.");this._clearForm()}}).catch(()=>{sap.m.MessageToast.show("Site not found.");this._clearForm()})},onSiteIdValueHelp:function(){const e=this.getView();if(!this._oSiteVHDialog){this._oSiteVHDialog=new sap.m.SelectDialog({title:"Select Site ID",liveChange:e=>{this._onSiteSearch(e)},confirm:e=>{this._onSiteSelect(e)},cancel:e=>{e.getSource().close()},items:{path:"/sites",template:new sap.m.StandardListItem({title:"{site_id}",description:"{customer_name} - {location}"})}});e.addDependent(this._oSiteVHDialog)}const t=this.getOwnerComponent().getModel();const n=t.bindList("/siteMaster");n.requestContexts().then(e=>{const t=e.map(e=>e.getObject());const n=new sap.ui.model.json.JSONModel({sites:t});this._oSiteVHDialog.setModel(n);this._oSiteVHDialog.open()}).catch(e=>{sap.m.MessageToast.show("Failed to load Site IDs");console.error(e)})},_onSiteSearch:function(e){const t=e.getParameter("value");const n=new sap.ui.model.Filter("site_id",sap.ui.model.FilterOperator.Contains,t);e.getSource().getBinding("items").filter([n])},_onSiteSelect:function(e){const t=e.getSource();const n=e.getParameter("selectedItem");if(!n){t.close();return}const s=n.getTitle();const a=this.byId("topName");a.setValue(s);a.fireChange({value:s});t.close()},onRepairStatusChange:function(e){const t=e.getSource();const n=t.getSelectedKey();const s=this.getView().getModel();const a=s.getProperty("/repairStatus");s.setProperty("/repairStatus",n);const o=this.byId("minorRepairStatus");if(n==="major"){s.setProperty("/minorRepairStatus",0);o.setEditable(false);this._generateCampaignNo({customer_name:s.getProperty("/customer"),location:s.getProperty("/location"),runner_id:s.getProperty("/runnerId")});sap.m.MessageToast.show("Major repair, new campaign generated");this.byId("minorRepairStatus").setEditable(false)}else if(n==="minor"){o.setEditable(true);const e=s.getProperty("/minorRepairStatus");if(![1,2,3].includes(e)){s.setProperty("/minorRepairStatus",1)}if(this._oldStatus==="major"){this._generateCampaignNo({customer_name:s.getProperty("/customer"),location:s.getProperty("/location"),runner_id:s.getProperty("/runnerId")});sap.m.MessageToast.show("Minor repair, new campaign generated");this.byId("minorRepairStatus").setEditable(false)}}},onMinorRepairStatusChange:function(e){const t=this.getView().getModel();const a=t.getProperty("/repairStatus");if(a!=="minor")return;let o=parseInt(e.getSource().getValue(),10);let i=this._previousMinorRepairStatus;if(isNaN(o)){e.getSource().setValue(i);return}if(i===1&&o!==2){n.show("Minor Repair Status can only move from 1 → 2");e.getSource().setValue(1);t.setProperty("/minorRepairStatus",1);return}if(i===2&&o!==3){n.show("Minor Repair Status can only move from 2 → 3");e.getSource().setValue(2);t.setProperty("/minorRepairStatus",2);return}if(i===3){s.information("Minor Repair Status is 3. Please switch to Major Repair Status.");e.getSource().setValue(3);t.setProperty("/minorRepairStatus",3);return}t.setProperty("/minorRepairStatus",o)},_fetchLastCampaign:function(e){const t=this.getView().getModel();const n=`/odata/v4/site-management/getLastCampaignNo`+`(customer_name='${e.customer_name}',`+`location='${e.location}',`+`runner_id='${e.runner_id}')`;$.ajax({url:n,method:"GET",success:function(n){if(n&&n.campaign_no){console.log("Last campaign found:",n);if(n.repair_status=="major"||n.minor_repair_status=="3"){console.log("old one expired, generating new one");sap.m.MessageToast.show("New Campaign Number Generated.");this._generateCampaignNo(e)}else{console.log("existing one is valid, applying the same");sap.m.MessageToast.show("Existing Campaign Number Applied.");t.setProperty("/campaignNo",n.campaign_no);t.setProperty("/repairStatus",n.repair_status);t.setProperty("/minorRepairStatus",n.minor_repair_status+1)}}else{console.log("No previous campaign found - generating one");sap.m.MessageToast.show("New Campaign Number Generated.");this._generateCampaignNo(e)}}.bind(this),error:function(e){console.error("Error fetching last campaign",e)}})},_generateCampaignNo:function(){const e=this.getView().getModel();$.ajax({url:"/odata/v4/site-management/campaign",method:"POST",contentType:"application/json",data:JSON.stringify({}),success:function(t){console.log("Generated campaign number:",t.campaign_no);e.setProperty("/campaignNo",t.camp_no)},error:function(e){sap.m.MessageBox.error(e.responseJSON?.error?.message||"Failed to generate campaign number")}})},_patchCampaign:function(e,t,n,s){if(!t){sap.m.MessageToast.show("Campaign ID is required");return}const a={repair_status:n,minor_repair_status:s,site_site_id:e};console.log("PATCH Campaign Payload:",a);$.ajax({url:`/odata/v4/site-management/campaign(camp_no='${encodeURIComponent(t)}')`,method:"PATCH",contentType:"application/json",data:JSON.stringify(a),success:function(){},error:function(e){sap.m.MessageToast.show("Campaign update failed: "+(e.responseJSON?.error?.message||"Unknown Error"));console.error("Campaign PATCH Error:",e)}})},_stopCampaignForLine:function(e){s.confirm("Do you want to stop this campaign?",{onClose:t=>{if(t!==s.Action.OK)return;$.ajax({url:`/odata/v4/site-management/campaign(camp_no='${encodeURIComponent(e.campaign_no)}')`,method:"PATCH",contentType:"application/json",data:JSON.stringify({repair_status:"stopped"}),success:()=>{sap.m.MessageToast.show("Campaign stopped")},error:()=>{sap.m.MessageToast.show("Failed to stop campaign")}})}})},_shouldCreateNewCampaign:function(e,t){const n=this.ExistingcampaignArray?.find(t=>t.line_name===e);if(!n)return false;if(n.curr_repair_status==="major"&&n.curr_minor_repair_status===0){return true}if(n.curr_repair_status==="minor"&&n.curr_minor_repair_status===3){return true}if(n.curr_repair_status==="minor"){if(t!==n.curr_minor_repair_status+1){sap.m.MessageToast.show("Minor repair can increase only by 1");return"BLOCK"}}return false},onLineCountChange:function(e){const t=parseInt(e.getParameter("value"),10);if(isNaN(t)||t<=0){this.byId("linesContainer").destroyItems();this.getView().getModel().setProperty("/lines",[]);return}const n=[];for(let e=0;e<t;e++){n.push({line_name:"",no_of_spg_sensors:0,no_of_mudgun_sensors:0,sensors:[]})}this._renderProductionLines(n,false)},_renderProductionLines:function(e,t){const n=this.byId("linesContainer");const s=this.getView().getModel();n.destroyItems();const a=[];e.forEach((e,o)=>{const i=new sap.m.Panel({headerText:"House / Production Line - "+(o+1),expandable:true,expanded:true}).addStyleClass("whiteCard sapUiMediumMarginBottom");const r=new sap.m.Input({value:e.line_name||"",editable:!t,liveChange:e=>{s.setProperty(`/lines/${o}/line_name`,e.getParameter("value"))}});const c=new sap.m.Input({value:{path:`/lines/${o}/campaign/campaign_no`,mode:sap.ui.model.BindingMode.TwoWay},width:"100%",editable:!t});const u=new sap.m.Input({type:"Number",value:e.no_of_spg_sensors||0,editable:!t,change:this._handleSpgChange.bind(this,o)});const l=new sap.m.Input({type:"Number",value:e.no_of_mudgun_sensors||0,editable:!t,change:e=>{this._handleMudgunChange(o,e);const t=s.getData();const n=t.customer;const a=t.location;const i=t.runnerId;const u=r.getValue();this._getCampaignNumber(n,a,i,u).then(e=>{c.setValue(e);s.setProperty(`/lines/${o}/campaign/campaign_no`,e);sap.m.MessageToast.show(`Campaign generated: ${e}`)}).catch(()=>{sap.m.MessageToast.show("Error generating campaign number")})}});const m=new sap.m.HBox({wrap:"Wrap"});const p=new sap.m.HBox({wrap:"Wrap"});(e.sensors||[]).forEach(e=>{const t=new sap.m.Input({width:"80px",value:e.sensor_name,editable:false});e.sensor_type==="SPG"?m.addItem(t):p.addItem(t)});const d=new sap.ui.layout.Grid({defaultSpan:"L4 M6 S12",content:[new sap.m.VBox({items:[new sap.m.Label({text:"Line Name",design:"Bold"}),r]}),new sap.m.VBox({items:[new sap.m.Label({text:"No of SPG Sensors",design:"Bold"}),u,m]}),new sap.m.VBox({items:[new sap.m.Label({text:"No of Mudgun Sensors",design:"Bold"}),l,p]})]});const g=new sap.m.Input({type:"Number",value:e.curr_repair_status==="minor"?e.curr_minor_repair_status||1:0,width:"100%",editable:e.curr_repair_status==="minor",change:e=>{let t=parseInt(e.getParameter("value")||0,10);if(_.getSelectedKey()==="minor"){if(![1,2,3].includes(t)){sap.m.MessageToast.show("Minor repair count can only be 1, 2, or 3");t=1;g.setValue(t)}}else{t=0;g.setValue(0)}s.setProperty(`/lines/${o}/campaign/minor_repair_count`,t)}});const _=new sap.m.ComboBox({selectedKey:e.curr_repair_status||"",width:"100%",editable:true,selectionChange:async t=>{const n=t.getSource().getSelectedKey();const s=this.getView().getModel();const a=s.getData();const i=e.line_name;const r=this.ExistingcampaignArray?.find(e=>e.line_name===i);s.setProperty(`/lines/${o}/campaign/repair_status`,n);const c=r&&r.curr_repair_status==="major"&&n==="minor";const u=r&&r.curr_repair_status==="minor"&&n==="major";if(c||u){const e=await this._getCampaignNumber(a.customer,a.location,a.runnerId,i);s.setProperty(`/lines/${o}/campaign/campaign_no`,e);if(c){s.setProperty(`/lines/${o}/campaign/minor_repair_count`,1);g.setValue(1);g.setEditable(true)}else{s.setProperty(`/lines/${o}/campaign/minor_repair_count`,0);g.setValue(0);g.setEditable(false)}s.refresh(true);g.setEditable(n==="minor");sap.m.MessageToast.show(`New Campaign Generated: ${e}`);return}if(n==="minor"){g.setEditable(true);if(r?.curr_repair_status==="minor"){}else{}g.setValue(1);s.setProperty(`/lines/${o}/campaign/minor_repair_count`,1)}if(n==="major"){g.setValue(0);g.setEditable(false);s.setProperty(`/lines/${o}/campaign/minor_repair_count`,0)}},items:[new sap.ui.core.Item({key:"major",text:"Major"}),new sap.ui.core.Item({key:"minor",text:"Minor"})]});const h=new sap.m.Button({text:"Stop Campaign",type:"Reject",visible:true,press:()=>{sap.m.MessageBox.confirm("Are you sure you want to stop the campaign?",{onClose:e=>{if(e===sap.m.MessageBox.Action.OK){s.setProperty(`/lines/${o}/campaign/campaign_no`,"");s.setProperty(`/lines/${o}/campaign/repair_status`,"");s.setProperty(`/lines/${o}/campaign/minor_repair_count`,0);s.setProperty(`/lines/${o}/curr_campaign`,"");s.setProperty(`/lines/${o}/curr_repair_status`,"");s.setProperty(`/lines/${o}/curr_minor_repair_status`,0)}}})}});const f=new sap.ui.layout.Grid({defaultSpan:"L4 M6 S12",content:[new sap.m.VBox({items:[new sap.m.Label({text:"Campaign No",design:"Bold"}),c]}),new sap.m.VBox({items:[new sap.m.Label({text:"Repair Status",design:"Bold"}),_]}),new sap.m.VBox({items:[new sap.m.Label({text:"Minor Repair Status",design:"Bold"}),g]}),new sap.m.VBox({alignItems:"Start",justifyContent:"End",items:[h]})]}).addStyleClass("sapUiSmallMarginTop");i.addContent(new sap.m.VBox({items:[d,f]}).addStyleClass("sapUiSmallMargin"));n.addItem(i);a.push({id:e.ID||null,line_name:e.line_name||"",lineNameInput:r,spgCount:e.no_of_spg_sensors||0,mudgunCount:e.no_of_mudgun_sensors||0,spgSensors:[],mudgunSensors:[],spgBox:m,mudgunBox:p,campaign:{campaign_no:e.curr_campaign||"",repair_status:e.curr_repair_status||"",minor_repair_count:e.curr_minor_repair_status||0}})});s.setProperty("/lines",a)},_handleSpgChange:function(e,t){const n=parseInt(t.getParameter("value"),10);const s=this.getView().getModel();const a=s.getProperty("/lines")[e];const o=a.spgBox;o.destroyItems();const i=[];for(let e=0;e<n;e++){const t=new sap.m.Input({width:"80px",placeholder:"NAME "+(e+1),change:t=>{i[e]=t.getSource().getValue();a.spgSensors=i;s.refresh()}});i.push("");o.addItem(t)}a.spgCount=n},_handleMudgunChange:function(e,t){const n=parseInt(t.getParameter("value"),10);const s=this.getView().getModel();const a=s.getProperty("/lines")[e];const o=a.mudgunBox;o.destroyItems();const i=[];for(let e=0;e<n;e++){const t=new sap.m.Input({width:"80px",placeholder:"NAME "+(e+1),change:t=>{i[e]=t.getSource().getValue();a.mudgunSensors=i;s.refresh()}});i.push("");o.addItem(t)}a.mudgunCount=n},onSave:function(){const e=this.getView().getModel();const t=e.getData();const n=this.byId("modeSelector")?.getSelectedKey();const s={customer_name:t.customer,location:t.location,runner_id:t.runnerId,productionLines:[]};const a=[];(t.lines||[]).forEach(e=>{const n=e.campaign||{};const o={line_name:e.line_name,no_of_spg_sensors:e.spgCount,no_of_mudgun_sensors:e.mudgunCount,curr_campaign:n.campaign_no||null,curr_repair_status:n.repair_status||null,curr_minor_repair_status:n.minor_repair_count||0,sensors:[...(e.spgSensors||[]).map(e=>({sensor_name:e,sensor_type:"SPG"})),...(e.mudgunSensors||[]).map(e=>({sensor_name:e,sensor_type:"MUDGUN"}))]};s.productionLines.push(o);if(n?.campaign_no){a.push({campaign_no:n.campaign_no,repair_status:n.repair_status||null,minor_repair_count:n.minor_repair_count||0,site_id:t.site_id||null,start_date:n.start_date||null,end_date:n.end_date||null,isActive:n.isActive!==undefined?n.isActive:true,Status:n.Status||"Open",customer_name:t.customer,location:t.location,runner_id:t.runnerId,productionLineName:e.line_name})}});if(n==="create"){const e=this.getOwnerComponent().getModel();const t=e.bindList("/siteMaster");const n=t.create(s);n.created().then(()=>{sap.m.MessageToast.show("Site created successfully");const t=e.bindList("/campaign");a.forEach(e=>{const n=t.create(e);n.created().then(()=>{console.log("Campaign created:",e.campaign_no)}).catch(e=>{console.error("Error creating campaign:",e)})})}).catch(e=>{sap.m.MessageToast.show(e?.message||"Error while creating site");console.error(e)})}else if(n==="maintain"){(t.lines||[]).forEach(e=>{if(!e.id){console.warn("Skipping line without ID:",e);return}const n=e.campaign||{};const s=this.ExistingcampaignArray?.find(t=>t.line_name===e.line_name);const a=!s||s.curr_campaign!==n.campaign_no||s.curr_repair_status!==n.repair_status||s.curr_minor_repair_status!==n.minor_repair_count;if(!a){console.log("No change for line, skipping:",e.line_name);return}const o={curr_campaign:n.campaign_no||null,curr_repair_status:n.repair_status||null,curr_minor_repair_status:n.minor_repair_count||0};const i=this.getOwnerComponent().getModel();const r=i.bindContext(`/siteProductionLine('${e.id}')`);r.requestObject().then(()=>{const e=r.getBoundContext();Object.keys(o).forEach(t=>{e.setProperty(t,o[t])});return i.submitBatch(r.getUpdateGroupId())}).then(()=>{sap.m.MessageToast.show("Site Updated successfully");console.log("Production line updated:",e.line_name);if(n?.campaign_no){const s={campaign_no:n.campaign_no,repair_status:n.repair_status||null,minor_repair_count:n.minor_repair_count||0,site_id:t.site_id,start_date:n.start_date||null,end_date:n.end_date||null,isActive:n.isActive!==undefined?n.isActive:true,Status:n.Status||"Open",customer_name:t.customer,location:t.location,runner_id:t.runnerId,productionLineName:e.line_name};const a=i.bindList("/campaign");const o=a.create(s);o.created().then(()=>console.log("Campaign created:",s.campaign_no)).catch(e=>console.error("Error creating campaign:",e))}}).catch(t=>{console.error("Error updating production line:",e.line_name,t)})})}},onReset:function(){s.confirm("Reset all fields?",{onClose:e=>{if(e==="OK"){this._initModel();this.byId("linesContainer").destroyItems();n.show("Reset Completed")}}})},_getCampaignNumber:function(e,t,n,s){const a=this.getOwnerComponent().getModel();const o=`/generateCampaignNumber(`+`customer_name='${e}',`+`location='${t}',`+`runner_id='${n}',`+`line_name='${s}')`;const i=a.bindContext(o);return i.requestObject().then(e=>e?.value||"").catch(e=>{console.error("Error generating campaign number",e);throw e})},_clearPage:function(){this.getView().getModel().setData(this._getEmptyData());this.byId("modeSelector").setSelectedKey("");this.byId("topName").setValue("");this.byId("customer").setSelectedKey("");this.byId("location").setSelectedKey("");this.byId("runnerId").setValue("");this.byId("lineCount").setValue("");this.byId("linesContainer").removeAllItems();this._setFieldsEditable(false)},_getEmptyData:function(){return{site_id:"",customer:"",location:"",runnerId:"",lineCount:"",mode:""}},onNavToHome:function(){const e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Home")}})});
//# sourceMappingURL=View1.controller.js.map