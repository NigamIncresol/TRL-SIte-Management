sap.ui.define(["sap/ui/core/mvc/Controller","sap/m/MessageToast","sap/m/MessageBox","sap/ui/model/json/JSONModel","sap/m/Label","sap/m/Input","sap/m/VBox","sap/m/HBox","sap/m/Panel"],function(e,t,s,n,o,i,a,r,d){"use strict";let c;return e.extend("com.trl.sitemanagementfe.controller.View3",{onInit:function(){c=this.getOwnerComponent().getModel();const e={runnerId:"",campaignNo:"",repairStatus:"",minorRepairStatus:"",shift:"",productionLines:[],isSensorEditable:true};const t=new n(e);this.getView().setModel(t,"formData");this._isExistingSensorData=false;const s=this.getOwnerComponent().getRouter();s.getRoute("RouteView3").attachPatternMatched(this._onRouteMatched,this)},_onRouteMatched:function(){this._clearPage()},getISTDate:function(){const e=new Date;const t=5.5*60*60*1e3;return new Date(e.getTime()+t).toISOString().split("T")[0]},onSiteIdLiveChange:function(e){const s=e.getSource();s.setValue("");t.show("Please select Site ID using the value help",{duration:2e3})},onProdLineLiveChange:function(e){const s=e.getSource();s.setValue("");t.show("Please select Line name using the value help",{duration:2e3})},onSiteIdValueHelp:function(){const e=this.getView();if(!this._oSiteVHDialog){this._oSiteVHDialog=new sap.m.SelectDialog({title:"Select Site ID",liveChange:e=>{this._onSiteSearch(e)},confirm:e=>{this._onSiteSelect(e)},cancel:()=>{this._oSiteVHDialog.close()},items:{path:"/sites",template:new sap.m.StandardListItem({title:"{site_id}",description:"{customer_name} - {location}"})}});e.addDependent(this._oSiteVHDialog)}const t=c.bindList("/siteMaster");t.requestContexts().then(e=>{const t=e.map(e=>e.getObject());const s=new sap.ui.model.json.JSONModel({sites:t});this._oSiteVHDialog.setModel(s);this._oSiteVHDialog.open()}).catch(e=>{sap.m.MessageToast.show("Failed to load Site IDs");console.error(e)})},_onSiteSearch:function(e){const t=e.getParameter("value");const s=new sap.ui.model.Filter("site_id",sap.ui.model.FilterOperator.Contains,t);e.getSource().getBinding("items").filter([s])},_onSiteSelect:function(e){const t=e.getParameter("selectedItem");if(!t)return;const s=t.getTitle();const n=this.byId("siteId");n.setValue(s);this._oSiteVHDialog.close()},onProdLineValueHelp:function(){let e=this.byId("siteId").getValue();if(!e){sap.m.MessageToast.show("Please select a Site ID !");return}const t=this.getView();if(!this._oProdVHDialog){this._oProdVHDialog=new sap.m.SelectDialog({title:"Select Production Line",liveChange:e=>{this._onProdLineSearch(e)},confirm:e=>{this._onProdLineSelect(e)},cancel:()=>{this._oProdVHDialog.close()},items:{path:"/prods",template:new sap.m.StandardListItem({title:"{line_name}",description:"Site ID : {site_site_id}"})}});t.addDependent(this._oProdVHDialog)}const s=c.bindContext(`/siteMaster(site_id='${e}')`,null,{$expand:{productionLines:{$expand:{sensors:true}}}});s.requestObject().then(e=>{console.log("received whole site data",e);this.siteMasterCompleteData=e;const t=e.productionLines||[];const s=new sap.ui.model.json.JSONModel({prods:t});this._oProdVHDialog.setModel(s);this._oProdVHDialog.open()}).catch(e=>{sap.m.MessageToast.show("Failed to load production lines.");console.error(e)})},_onProdLineSearch:function(e){const t=e.getParameter("value");const s=new sap.ui.model.Filter("line_name",sap.ui.model.FilterOperator.Contains,t);e.getSource().getBinding("items").filter([s])},_onProdLineSelect:function(e){const t=e.getParameter("selectedItem");if(!t)return;const s=t.getTitle();const n=this.byId("ProductionLineId1");n.setValue(s);this._oProdVHDialog.close()},onFindPress:function(){const e=this.getView();const t=e.getModel("formData");const s=e.byId("siteId").getValue().trim();const n=e.byId("ProductionLineId1").getValue().trim();const o=e.byId("siteDate1").getValue().trim();const i=e.byId("shiftSelect").getSelectedKey()||"A";if(!s||!n||!o){sap.m.MessageToast.show("Please fill all required fields.");return}t.setProperty("/siteMaster",{});t.setProperty("/campinfo",{});if(this.siteMasterCompleteData){t.setProperty("/siteMaster",{customer_name:this.siteMasterCompleteData.customer_name||"",location:this.siteMasterCompleteData.location||"",runner_id:this.siteMasterCompleteData.runner_id||""})}const a=[new sap.ui.model.Filter("site_id","EQ",s),new sap.ui.model.Filter("productionLineName","EQ",n),new sap.ui.model.Filter("reading_date","EQ",o),new sap.ui.model.Filter("shift_code","EQ",i)];const r=c.bindList("/sensorReading",null,null,a);r.requestContexts().then(e=>{if(e.length>0){const s=e.map(e=>e.getObject());const o=s.some(e=>e.sensorStageCompleted===true);t.setProperty("/isSensorEditable",!o);this._isExistingSensorData=true;if(o){sap.m.MessageToast.show("Sensor stage already submitted. Editing disabled.")}else{sap.m.MessageToast.show("Existing sensor reading found for the selected line/shift/date")}const i=s[0];t.setProperty("/campinfo",{campaign_no:i.curr_campaign||"",repair_status:i.curr_repair_status||"",minor_repair_status:i.curr_minor_repair_status||0});this.renderSensorFieldFromMaster(n,s)}else{sap.m.MessageToast.show("No sensor reading found for the selected line/shift/date");const e=this.siteMasterCompleteData?.productionLines.find(e=>e.line_name===n);t.setProperty("/campinfo",{campaign_no:e?.curr_campaign||"",repair_status:e?.curr_repair_status||"",minor_repair_status:e?.curr_minor_repair_status||0});t.setProperty("/isSensorEditable",true);this._isExistingSensorData=false;this.renderSensorFieldFromMaster(n,[])}}).catch(e=>{sap.m.MessageToast.show(e?.message||"No readings found");const s=this.siteMasterCompleteData?.productionLines.find(e=>e.line_name===n);t.setProperty("/campinfo",{campaign_no:s?.curr_campaign||"",repair_status:s?.curr_repair_status||"",minor_repair_status:s?.curr_minor_repair_status||0});this.renderSensorFieldFromMaster(n,[])})},renderSensorFieldFromMaster:function(e,t=[]){const s=this.getView();const n=s.getModel("formData");const o=s.byId("linesContainer");o.destroyItems();n.setProperty("/productionLines",[]);if(!this.siteMasterCompleteData?.productionLines)return;const i=this.siteMasterCompleteData.productionLines.filter(t=>t.line_name===e);i.forEach(e=>{const s={line_name:e.line_name,sensors:[]};const i=new sap.m.Panel({headerText:"Production Line : "+e.line_name,expandable:true,expanded:true});const a=new sap.ui.layout.Grid({defaultSpan:"L6 M6 S12",hSpacing:2,width:"100%"});const r=new sap.m.Panel({headerText:"SPG SENSOR",class:"whiteCard",width:"100%"});const d=new sap.m.VBox;r.addContent(d);const c=new sap.m.Panel({headerText:"MUDGUN SENSOR",class:"whiteCard",width:"100%"});const l=new sap.m.VBox;c.addContent(l);e.sensors.forEach(e=>{const n=t.find(t=>t.sensor_name===e.sensor_name);const o={sensorId:e.ID,sensor_name:e.sensor_name,sensor_type:e.sensor_type,reading:n?n.reading:""};s.sensors.push(o);const i=new sap.m.HBox({justifyContent:"SpaceBetween",class:"sapUiSmallMarginBottom",items:[new sap.m.Label({text:e.sensor_name}).addStyleClass("sapUiTinyMarginTop"),new sap.m.Input({type:"Number",width:"100px",placeholder:"Reading...",value:o.reading,liveChange:e=>{o.reading=e.getParameter("value")}})]});if(e.sensor_type==="SPG")d.addItem(i);else if(e.sensor_type==="MUDGUN")l.addItem(i)});a.addContent(r);a.addContent(c);i.addContent(a);i.addStyleClass("sapUiSmallMarginBottom");o.addItem(i);n.getProperty("/productionLines").push(s)});n.refresh(true)},onSave:function(){const e=this.getView();const t=e.getModel("formData");const s=t.getData();const n=e.byId("siteId").getValue().trim();const o=e.byId("ProductionLineId1").getValue().trim();const i=e.byId("siteDate1").getValue().trim();const a=e.byId("shiftSelect").getSelectedKey()||"A";if(!n||!o||!i){sap.m.MessageToast.show("Please fill all required fields.");return}if(!s.productionLines?.length){sap.m.MessageToast.show("No sensors to save");return}s.productionLines.forEach(e=>{if(e.line_name!==o){return}(e.sensors||[]).forEach(e=>{if(e.reading===""||e.reading==null){return}const t={site_id:n,productionLineName:o,reading_date:i,shift_code:a,sensor_name:e.sensor_name,reading:Number(e.reading),curr_campaign:s.campinfo?.campaign_no||"",curr_repair_status:s.campinfo?.repair_status||"",curr_minor_repair_status:s.campinfo?.minor_repair_status??0};if(this._isExistingSensorData){const s=`/sensorReading(`+`site_id='${t.site_id}',`+`productionLineName='${t.productionLineName}',`+`reading_date='${t.reading_date}',`+`shift_code='${t.shift_code}',`+`sensor_name='${t.sensor_name}'`+`)`;const n=c.bindContext(s);n.requestObject().then(()=>{const e=n.getBoundContext();Object.keys(t).forEach(s=>{e.setProperty(s,t[s])});return c.submitBatch(n.getUpdateGroupId())}).then(()=>{console.log("Updated sensor:",e.sensor_name)}).catch(t=>{console.error(t);sap.m.MessageToast.show("Update failed for "+e.sensor_name)})}else{const s=c.bindList("/sensorReading");const n=s.create(t);n.created().then(()=>{console.log("Created sensor:",e.sensor_name)}).catch(t=>{console.error(t);sap.m.MessageToast.show("Create failed for "+e.sensor_name)})}})});sap.m.MessageToast.show("Sensor readings saved successfully")},onSubmit:function(){s.confirm("Confirm submission? Changes will not be allowed after this.",{title:"Confirm Submission",actions:[s.Action.YES,s.Action.NO],emphasizedAction:s.Action.YES,onClose:function(e){if(e===s.Action.YES){this.markSensorStageCompleted()}}.bind(this)})},markSensorStageCompleted:function(){const e=this.getView();const t=e.getModel("formData");const s=t.getData();const n=e.byId("siteId").getValue().trim();const o=e.byId("ProductionLineId1").getValue().trim();const i=e.byId("siteDate1").getValue().trim();const a=e.byId("shiftSelect").getSelectedKey()||"A";if(!n||!o||!i){sap.m.MessageToast.show("Missing required fields");return}const r=[];s.productionLines.forEach(e=>{if(e.line_name!==o){return}(e.sensors||[]).forEach(e=>{const t=`/sensorReading(`+`site_id='${n}',`+`productionLineName='${o}',`+`reading_date='${i}',`+`shift_code='${a}',`+`sensor_name='${e.sensor_name}'`+`)`;const s=c.bindContext(t);const d=s.requestObject().then(()=>{const e=s.getBoundContext();e.setProperty("sensorStageCompleted",true);return c.submitBatch(s.getUpdateGroupId())}).then(()=>{console.log("Sensor submitted:",e.sensor_name)}).catch(t=>{console.error(t);sap.m.MessageToast.show("Submission failed for "+e.sensor_name)});r.push(d)})});Promise.allSettled(r).then(()=>{sap.m.MessageToast.show("Sensor stage submitted successfully");t.setProperty("/isSensorEditable",false);t.refresh()})},_clearPage:function(){const e=this.getView().getModel("formData");e.setData(this._getEmptyFormData());this.byId("siteId").setValue("");this.byId("ProductionLineId1").setValue("");this.byId("siteDate1").setValue(null);this.byId("shiftSelect").setSelectedKey("");this.byId("linesContainer").removeAllItems()},_getEmptyFormData:function(){return{shift:"",siteMaster:{customer_name:"",location:"",runner_id:""},campinfo:{campaign_no:"",repair_status:"",minor_repair_status:""},isSensorEditable:false}},onNavToHome:function(){const e=sap.ui.core.UIComponent.getRouterFor(this);e.navTo("Home")}})});
//# sourceMappingURL=View3.controller.js.map